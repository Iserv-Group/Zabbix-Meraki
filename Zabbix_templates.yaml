zabbix_export:
  version: '5.2'
  date: '2021-04-25T17:59:27Z'
  groups:
    -
      name: Meraki_Autodiscover
    -
      name: Templates/Applications
    -
      name: 'Templates/Network devices'
  templates:
    -
      template: 'Meraki Device Discovery'
      name: 'Meraki Device Discovery'
      description: 'Template used to create Zabbix items and triggers for all devices on a given Meraki Network. Data Pulled automatically from Dashboard API export.'
      groups:
        -
          name: Templates/Applications
        -
          name: 'Templates/Network devices'
      applications:
        -
          name: Device
        -
          name: Network
        -
          name: WAN
      items:
        -
          name: '{HOSTNAME} data pull'
          type: EXTERNAL
          key: 'meraki.sh[network.data,{$NETWORK_ID}]'
          delay: 5m
          history: 7d
          trends: '0'
          status: DISABLED
          value_type: TEXT
          applications:
            -
              name: Network
        -
          name: '{HOSTNAME} data pull - uplink'
          type: EXTERNAL
          key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
          delay: 5m
          history: 7d
          trends: '0'
          value_type: TEXT
          applications:
            -
              name: WAN
        -
          name: '{HOSTNAME} data pull - vpn statistics'
          type: EXTERNAL
          key: 'meraki.sh[network.uplink.vpnstats.data,{$NETWORK_ID}]'
          delay: 15m
          trends: '0'
          value_type: TEXT
          applications:
            -
              name: WAN
        -
          name: '{HOSTNAME} Status Check'
          type: DEPENDENT
          key: 'network.status[{$NETWORK_ID}]'
          delay: '0'
          status: DISABLED
          applications:
            -
              name: Network
          valuemap:
            name: 'Meraki Device Status'
          preprocessing:
            -
              type: JSONPATH
              parameters:
                - '$.*.status'
            -
              type: STR_REPLACE
              parameters:
                - '"online"'
                - '2'
            -
              type: STR_REPLACE
              parameters:
                - '"alerting"'
                - '1'
            -
              type: STR_REPLACE
              parameters:
                - '"offline"'
                - '0'
            -
              type: TRIM
              parameters:
                - '[]'
            -
              type: JAVASCRIPT
              parameters:
                - |
                  var myArray = value.split(",").map(Number);
                  var max = myArray.reduce(function(a, b) {
                      return Math.max(a, b);
                  });
                  return max
          master_item:
            key: 'meraki.sh[network.data,{$NETWORK_ID}]'
          triggers:
            -
              expression: '{max(4m)}=0'
              name: 'Network Unreachable for 5 Minute'
              priority: INFO
              description: 'All devices on this Meraki Network have been unreachable from the Meraki dashboard in 5 min.'
              dependencies:
                -
                  name: 'Network Unreachable for 10 Minute'
                  expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(10m)}=0'
                -
                  name: 'Network Unreachable for 15 Minute'
                  expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(15m)}=0'
            -
              expression: '{max(10m)}=0'
              name: 'Network Unreachable for 10 Minute'
              priority: WARNING
              description: 'All devices on this Meraki Network have been unreachable from the Meraki dashboard in 10 min.'
              dependencies:
                -
                  name: 'Network Unreachable for 15 Minute'
                  expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(15m)}=0'
            -
              expression: '{max(15m)}=0'
              name: 'Network Unreachable for 15 Minute'
              priority: AVERAGE
              description: |
                All devices on this Meraki Network have been unreachable from the Meraki dashboard in 15 min.
                <b>Notes from Meraki Dashboard</b>
                {$MX_NOTES}
        -
          name: '{HOSTNAME} Uplink Status Check'
          type: DEPENDENT
          key: 'network.uplink.status[{$NETWORK_ID}]'
          delay: '0'
          applications:
            -
              name: Network
          valuemap:
            name: 'Meraki Device Status'
          preprocessing:
            -
              type: JSONPATH
              parameters:
                - '$.*.status'
            -
              type: STR_REPLACE
              parameters:
                - '"online"'
                - '2'
            -
              type: STR_REPLACE
              parameters:
                - '"alerting"'
                - '1'
            -
              type: STR_REPLACE
              parameters:
                - '"offline"'
                - '0'
            -
              type: TRIM
              parameters:
                - '[]'
            -
              type: JAVASCRIPT
              parameters:
                - |
                  var myArray = value.split(",").map(Number);
                  var max = myArray.reduce(function(a, b) {
                      return Math.max(a, b);
                  });
                  return max
          master_item:
            key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
      discovery_rules:
        -
          name: 'Discover Meraki Devices'
          type: EXTERNAL
          key: 'meraki.sh[device.discovery, {$NETWORK_ID}]'
          delay: 5m
          lifetime: 1h
          item_prototypes:
            -
              name: '{#NAME} Status Check'
              type: DEPENDENT
              key: 'device.status[{#SERIAL}]'
              delay: '0'
              trends: 180d
              applications:
                -
                  name: Device
              valuemap:
                name: 'Meraki Device Status'
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.serial == ''{#SERIAL}'')].status'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["online"]'
                    - '2'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["alerting"]'
                    - '1'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["offline"]'
                    - '0'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
              trigger_prototypes:
                -
                  expression: '{max(6m)}=0'
                  name: '{#NAME} Unreachable for 5 Minute'
                  priority: INFO
                  description: |
                    The following device has been unreachable from the Meraki cloud for 5 min
                    <b>Meraki Org and Network Name:</b>  <i>{HOST.NAME}</i>
                    <b>Meraki Device Name:</b>  <i>{#NAME}</i>
                  dependencies:
                    -
                      name: 'Network Unreachable for 5 Minute'
                      expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(4m)}=0'
                    -
                      name: 'Network Unreachable for 10 Minute'
                      expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(10m)}=0'
                    -
                      name: 'Network Unreachable for 15 Minute'
                      expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(15m)}=0'
                    -
                      name: '{#NAME} Unreachable for 10 Minute'
                      expression: '{Meraki Device Discovery:device.status[{#SERIAL}].max(11m)}=0'
                    -
                      name: '{#NAME} Unreachable for 15 Minute'
                      expression: '{Meraki Device Discovery:device.status[{#SERIAL}].max(16m)}=0'
                -
                  expression: '{max(11m)}=0'
                  name: '{#NAME} Unreachable for 10 Minute'
                  priority: WARNING
                  description: |
                    The following device has been unreachable from the Meraki cloud for 10 min
                    <b>Meraki Org and Network Name:</b>  <i>{HOST.NAME}</i>
                    <b>Meraki Device Name:</b>  <i>{#NAME}</i>
                  dependencies:
                    -
                      name: 'Network Unreachable for 10 Minute'
                      expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(10m)}=0'
                    -
                      name: 'Network Unreachable for 15 Minute'
                      expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(15m)}=0'
                    -
                      name: '{#NAME} Unreachable for 15 Minute'
                      expression: '{Meraki Device Discovery:device.status[{#SERIAL}].max(16m)}=0'
                -
                  expression: '{max(16m)}=0'
                  name: '{#NAME} Unreachable for 15 Minute'
                  priority: AVERAGE
                  description: |
                    The following device has been unreachable from the Meraki cloud for 15 min
                    <b>Meraki Org and Network Name:</b>  <i>{HOST.NAME}</i>
                    <b>Meraki Device Name:</b>  <i>{#NAME}</i>
                  dependencies:
                    -
                      name: 'Network Unreachable for 15 Minute'
                      expression: '{Meraki Device Discovery:network.status[{$NETWORK_ID}].max(15m)}=0'
            -
              name: '{#NAME} Status Check'
              type: EXTERNAL
              key: 'meraki.sh[device.status, {#SERIAL}]'
              history: 30d
              trends: 180d
              status: DISABLED
              discover: NO_DISCOVER
              applications:
                -
                  name: Device
              valuemap:
                name: 'Meraki Device Status'
        -
          name: 'Discovered WAN Connections'
          type: EXTERNAL
          key: 'meraki.sh[wan.discovery,{$NETWORK_ID}]'
          delay: 5m
          lifetime: 7d
          item_prototypes:
            -
              name: '{#NAME} {#INT_NAME} Interface Signal Type (3G-4G)'
              type: DEPENDENT
              key: 'wan.uplink.status[{#SERIAL},connectionType]'
              delay: '0'
              trends: '0'
              value_type: TEXT
              applications:
                -
                  name: WAN
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.serial == ''{#SERIAL}'')].uplinks'
                -
                  type: JSONPATH
                  parameters:
                    - '$.*.*'
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.interface == "cellular")].connectionType'
                -
                  type: TRIM
                  parameters:
                    - '["]'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
            -
              name: '{#NAME} {#INT_NAME} Interface Latency'
              type: DEPENDENT
              key: 'wan.uplink.status[{#SERIAL},Latency]'
              delay: '0'
              value_type: FLOAT
              applications:
                -
                  name: WAN
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$.[?(@.serial == ''{#SERIAL}'')].timeSeries'
                -
                  type: JSONPATH
                  parameters:
                    - $..latencyMs
                -
                  type: TRIM
                  parameters:
                    - '["]'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
            -
              name: '{#NAME} {#INT_NAME} Interface Packet Loss'
              type: DEPENDENT
              key: 'wan.uplink.status[{#SERIAL},PacketLoss]'
              delay: '0'
              value_type: FLOAT
              applications:
                -
                  name: WAN
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$.[?(@.serial == ''{#SERIAL}'')].timeSeries'
                -
                  type: JSONPATH
                  parameters:
                    - $..lossPercent
                -
                  type: TRIM
                  parameters:
                    - '["]'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
            -
              name: '{#NAME} {#INT_NAME} Interface Signal Strength (RSRP)'
              type: DEPENDENT
              key: 'wan.uplink.status[{#SERIAL},rsrp]'
              delay: '0'
              value_type: FLOAT
              applications:
                -
                  name: WAN
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.serial == ''{#SERIAL}'')].uplinks'
                -
                  type: JSONPATH
                  parameters:
                    - '$.*.*'
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.interface == "cellular")].signalStat.rsrp'
                -
                  type: TRIM
                  parameters:
                    - '["]'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
            -
              name: '{#NAME} {#INT_NAME} Interface Signal Strength (RSRQ)'
              type: DEPENDENT
              key: 'wan.uplink.status[{#SERIAL},rsrq]'
              delay: '0'
              value_type: FLOAT
              applications:
                -
                  name: WAN
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.serial == ''{#SERIAL}'')].uplinks'
                -
                  type: JSONPATH
                  parameters:
                    - '$.*.*'
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.interface == "cellular")].signalStat.rsrq'
                -
                  type: TRIM
                  parameters:
                    - '["]'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
            -
              name: '{#NAME} {#INT_NAME} Interface Status Check'
              type: DEPENDENT
              key: 'wan.uplink.status[{#SERIAL}, Uplink StatusCheck]'
              delay: '0'
              history: 30d
              applications:
                -
                  name: WAN
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.serial == ''{#SERIAL}'')].uplinks'
                -
                  type: JSONPATH
                  parameters:
                    - '$.*.*'
                -
                  type: JSONPATH
                  parameters:
                    - '$[?(@.interface == ''{#INT_NAME}'')].status'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["active"]'
                    - '3'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["ready"]'
                    - '2'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["failed"]'
                    - '1'
                -
                  type: STR_REPLACE
                  parameters:
                    - '["not connected"]'
                    - '0'
              master_item:
                key: 'meraki.sh[network.uplink.data,{$NETWORK_ID}]'
              trigger_prototypes:
                -
                  expression: '{max(15m)}=1'
                  name: '{#INT_NAME} Uplink on {#NAME} down for 15 min'
                  priority: INFO
                  description: |
                    The {#INT_NAME} connection at this location has been down for over 15 min.
                    <b>Notes from Meraki Dashboard</b>
                    {#NOTES}
          graph_prototypes:
            -
              name: '{#INT_NAME} on {#NAME} Latency'
              ymin_type_1: FIXED
              ymax_type_1: FIXED
              graph_items:
                -
                  sortorder: '1'
                  drawtype: FILLED_REGION
                  color: FF0080
                  calc_fnc: ALL
                  item:
                    host: 'Meraki Device Discovery'
                    key: 'wan.uplink.status[{#SERIAL},Latency]'
            -
              name: '{#INT_NAME} on {#NAME} Packet Loss'
              ymin_type_1: FIXED
              ymax_type_1: FIXED
              graph_items:
                -
                  sortorder: '1'
                  drawtype: FILLED_REGION
                  color: FF0000
                  calc_fnc: ALL
                  item:
                    host: 'Meraki Device Discovery'
                    key: 'wan.uplink.status[{#SERIAL},PacketLoss]'
            -
              name: '{#INT_NAME} on {#NAME} Signal Strength (RSRP)'
              graph_items:
                -
                  sortorder: '1'
                  drawtype: FILLED_REGION
                  color: F63100
                  item:
                    host: 'Meraki Device Discovery'
                    key: 'wan.uplink.status[{#SERIAL},rsrp]'
            -
              name: '{#INT_NAME} on {#NAME} Signal Strength (RSRQ)'
              graph_items:
                -
                  sortorder: '1'
                  drawtype: FILLED_REGION
                  color: 1A7C11
                  item:
                    host: 'Meraki Device Discovery'
                    key: 'wan.uplink.status[{#SERIAL},rsrq]'
            -
              name: '{#INT_NAME} on {#NAME} Uplink Status Check Graph'
              graph_items:
                -
                  sortorder: '1'
                  color: F63100
                  calc_fnc: ALL
                  item:
                    host: 'Meraki Device Discovery'
                    key: 'wan.uplink.status[{#SERIAL}, Uplink StatusCheck]'
          lld_macro_paths:
            -
              lld_macro: '{#MAC}'
              path: $.mac
      macros:
        -
          macro: '{$MX_NOTES}'
          value: '{#MX_NOTES}'
        -
          macro: '{$NETWORK_ID}'
          value: '{#NETWORK_ID}'
    -
      template: 'Meraki Network Discovery'
      name: 'Meraki Network Discovery'
      description: 'Template used to create Meraki Hosts automatically from Dashboard API export.'
      groups:
        -
          name: Templates/Applications
        -
          name: 'Templates/Network devices'
      discovery_rules:
        -
          name: 'Meraki Host Creation'
          type: EXTERNAL
          key: 'meraki.sh[network.discovery]'
          delay: 1d
          lifetime: 7d
          host_prototypes:
            -
              host: 'Meraki {#NETWORK_NAME}'
              name: 'Meraki {#NETWORK_NAME}'
              group_links:
                -
                  group:
                    name: Meraki_Autodiscover
              group_prototypes:
                -
                  name: 'Meraki/{#ORG}'
              templates:
                -
                  name: 'Meraki Device Discovery'
              macros:
                -
                  macro: '{$MX_NOTES}'
                  value: '{#MX_NOTES}'
                -
                  macro: '{$NETWORK_ID}'
                  value: '{#NETWORK_ID}'
              custom_interfaces: 'YES'
              interfaces:
                - {  }
  value_maps:
    -
      name: 'Meraki Device Status'
      mappings:
        -
          value: '0'
          newvalue: Offline
        -
          value: '1'
          newvalue: Alerting
        -
          value: '2'
          newvalue: Online
